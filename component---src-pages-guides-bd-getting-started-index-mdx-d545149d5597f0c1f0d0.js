"use strict";(self.webpackChunkzerthox_github_io=self.webpackChunkzerthox_github_io||[]).push([[694],{4316:function(e,t,n){n.r(t),n.d(t,{_frontmatter:function(){return i},default:function(){return h}});var a=n(3366),o=(n(7294),n(4983)),s=n(9739),r=["components"],i={},p=function(e){return function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,o.kt)("div",t)}},l=p("Banner"),d=p("CodeTabs"),c={_frontmatter:i},m=s.Z;function h(e){var t=e.components,n=(0,a.Z)(e,r);return(0,o.kt)(m,Object.assign({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)(l,{type:"warn",mdxType:"Banner"},(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"This guide has not been updated!")),(0,o.kt)("p",null,"The Discord update on 27 September 2022 contained some major changes to fundamental characteristics of their production code.\nA lot of named exports have had their names minified and module exports became read-only properties.\nThis changes the way internals can be used substantially.")),(0,o.kt)(l,{type:"warn",mdxType:"Banner"},(0,o.kt)("p",null,"This article assumes you are familiar with modern ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript"},"JavaScript"),"\nlike ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions"},"Arrow functions"),",\n",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment"},"Destructuring"),"\nand ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining"},"Optional Chaining"),"\nas well as the ",(0,o.kt)("a",{parentName:"p",href:"https://reactjs.org"},"React")," UI library!")),(0,o.kt)("h2",null,"Environment"),(0,o.kt)("p",null,"As you may already know, the Discord desktop application uses ",(0,o.kt)("a",{parentName:"p",href:"https://www.electronjs.org"},"Electron"),".\nThe UI is created using ",(0,o.kt)("a",{parentName:"p",href:"https://reactjs.org"},"React")," and all of the data is handled by a custom event system and a custom ",(0,o.kt)("a",{parentName:"p",href:"https://facebook.github.io/flux/"},"Flux")," implementation.\nTheir source is most likely written in ",(0,o.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org"},"TypeScript"),", however that is mostly irrelevant for plugin development.\nEverything is transpiled and then bundled together using ",(0,o.kt)("a",{parentName:"p",href:"https://webpack.js.org"},"webpack"),"."),(0,o.kt)("p",null,"Thanks to being based on ",(0,o.kt)("a",{parentName:"p",href:"https://www.chromium.org/Home"},"Chromium"),", Electron's renderer window has the ",(0,o.kt)("a",{parentName:"p",href:"https://developer.chrome.com/docs/devtools/"},"Chrome DevTools"),".\nSince the Discord update on 25 January 2022 they are disabled by default.\nYou can reenable them in BetterDiscord's developer settings."),(0,o.kt)("p",null,(0,o.kt)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"unset",marginRight:"unset",maxWidth:"688px",marginTop:"10px",marginBottom:"10px"}},"\n      ",(0,o.kt)("a",{parentName:"span",className:"gatsby-resp-image-link",href:"/static/4f1328e274d88a5a8c049d1e90d36d21/ebf47/bd-devtools-setting.png",style:{display:"block"},target:"_blank",rel:"noopener"},"\n    ",(0,o.kt)("span",{parentName:"a",className:"gatsby-resp-image-background-image",style:{paddingBottom:"27.42857142857143%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAuUlEQVQY04XQ3QqCQBAF4H2jysxV13XV9TdlRRMK664X6LanP+EYIkF18cGwsIc5w7LSwHRnVHUHFRcQoYbNJQ5uuLBX85rjKbJ3AlRNT5jOGzRmQHFs4UtNRJguApWRz3nieHPozhbohpGw6cEVMbwgmT+sw/4GzhtyP8LW8rDZcjCd1ajNCVKltDrV4e+qXP5EtX0Fy/KR3a+4PR9g093y0iAtGqikXES6pG3Wt/rGsgXytoe5jHgBHMGtuMBCWFwAAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,o.kt)("img",{parentName:"a",className:"gatsby-resp-image-image",alt:"BetterDiscord dev tools settings",title:"BetterDiscord dev tools settings",src:"/static/4f1328e274d88a5a8c049d1e90d36d21/ebf47/bd-devtools-setting.png",srcSet:["/static/4f1328e274d88a5a8c049d1e90d36d21/4edbd/bd-devtools-setting.png 175w","/static/4f1328e274d88a5a8c049d1e90d36d21/13ae7/bd-devtools-setting.png 350w","/static/4f1328e274d88a5a8c049d1e90d36d21/ebf47/bd-devtools-setting.png 688w"],sizes:"(max-width: 688px) 100vw, 688px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy",decoding:"async"}),"\n  "),"\n    ")),(0,o.kt)("p",null,"Afterwards you can access the dev tools by pressing ",(0,o.kt)("inlineCode",{parentName:"p"},"Ctrl")," + ",(0,o.kt)("inlineCode",{parentName:"p"},"Shift")," + ",(0,o.kt)("inlineCode",{parentName:"p"},"I")," (or ",(0,o.kt)("inlineCode",{parentName:"p"},"Cmd")," + ",(0,o.kt)("inlineCode",{parentName:"p"},"Opt")," + ",(0,o.kt)("inlineCode",{parentName:"p"},"I")," on a Mac).\nThe dev tools will be ",(0,o.kt)("strong",{parentName:"p"},"extremely important")," for any kind of reverse engineering later on and can be used to experiment in the console."),(0,o.kt)("h2",null,"React Dev Tools"),(0,o.kt)("p",null,"React Developer Tools extends the regular dev tools with React specific tabs.\nIf you have debugged a React application before, you should be familiar with them.\nThey will be very helpful when working with Discord's own React components."),(0,o.kt)("p",null,"In order to use them in Discord, you will need to have a ",(0,o.kt)("a",{parentName:"p",href:"https://www.google.com/intl/en_us/chrome/"},"Chrome")," installation on your computer.\nInstall the ",(0,o.kt)("a",{parentName:"p",href:"https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi/"},"React Developer Tools extension")," from the Chrome Web Store.\n",(0,o.kt)("em",{parentName:"p"},"(As an alternative manually mimicking the folder structure and placing the extension files in there will also suffice.)"),"\nThen enable the setting in BetterDiscord's developer settings and the dev tools will automatically be loaded in Discord as well."),(0,o.kt)("p",null,(0,o.kt)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"unset",marginRight:"unset",maxWidth:"690px",marginTop:"10px",marginBottom:"10px"}},"\n      ",(0,o.kt)("a",{parentName:"span",className:"gatsby-resp-image-link",href:"/static/e3b8b7ebc174f0252c4bbd47349adcd7/1e043/react-dev-tools.png",style:{display:"block"},target:"_blank",rel:"noopener"},"\n    ",(0,o.kt)("span",{parentName:"a",className:"gatsby-resp-image-background-image",style:{paddingBottom:"64.57142857142857%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACh0lEQVQ4y1WT6W7TQBSF/RoI1DVxvM54d+wkjtUmcRYKlFIW0QISAgQSqEW0VUUrQCAQIPGPF+BFP2S7KeHHsaXRne+eM3dG8fwY6QR4QRvHDXG9COmGOF6EkD5BlKDpgtUVk5XVda5eW8IwBKbtYpoO3SgmiiKCMEU4AYrwO1hOG1tGWE6M7bQRXoJuB7RMv5Jm+aiGh2YF+HGfjt8hTHJU06NpeFhOUq2X+xXZn+JNdnF6BZabVJs0O6z/C9LtkIbm8PrgiPH1HVpmuRZhiBBD+FWN7SYodtRHZmOsdIAdZmiGVzuz/jmsXQastyRvDt4xLG7j+wPieELYbuOGDqpRN1ZMN0XmU+zeGNEZYoUZuojRLiCLKoGnZx+Zbt3BDXpIr40hgsrtvEYp48lsgugWGG6K5iQYMr50tag1VXL+4Qu3dh6QZkPSbIRwk/9qlfIj0gFmsonXG2H7nYsBhHXsC5WN11qSsw9f6G9MKremjCvI4tEommpjRxlBsc3w5j3Cdo7WEmja/9J1yfqazvn5J/LBjDVVXMK0edPSYaM7Qd28TfH0kMdHH+nff4aabdHozWguSM1mLCcF77/9It+YVG71hdswBytL+yesPjrBf/sD6/AnrRefWN4/ZmlvriOW9o9ZeXTClYfHnP7+Q54Xl8DFW1BFbgY5qp9jju5gX9/DmjzAHmyj9aZo2Qwj38JIR6hBzorscvb5O/nmtBpQCSkfxRxcR+5MaCQFZnEPcfcF3YevCG/sY21uYw12UPtbNLszmp0py/GQ91//Ra4G6qXVcC6BzXRMoz1C39hG7j7Hv/+ScOcpg90n9G7toXXrhmo6ZjkccPr5Rw1U68jqxUOYR/4Lu6WwTaBlxwAAAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,o.kt)("img",{parentName:"a",className:"gatsby-resp-image-image",alt:"React dev tools",title:"React dev tools",src:"/static/e3b8b7ebc174f0252c4bbd47349adcd7/1e043/react-dev-tools.png",srcSet:["/static/e3b8b7ebc174f0252c4bbd47349adcd7/4edbd/react-dev-tools.png 175w","/static/e3b8b7ebc174f0252c4bbd47349adcd7/13ae7/react-dev-tools.png 350w","/static/e3b8b7ebc174f0252c4bbd47349adcd7/1e043/react-dev-tools.png 690w"],sizes:"(max-width: 690px) 100vw, 690px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy",decoding:"async"}),"\n  "),"\n    ")),(0,o.kt)("h2",null,"BetterDiscord API"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://betterdiscord.app"},"BetterDiscord"),"'s full API will ",(0,o.kt)("strong",{parentName:"p"},"not")," be covered here in details.\nYou can find additional information on the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/"},"BetterDiscord documentation")," (still work in progress).\nIf you encounter any outdated or unclear parts, you should ask in the ",(0,o.kt)("a",{parentName:"p",href:"https://discord.gg/0Tmfo5ZbORCRqbAd"},"BetterDiscord server"),"."),(0,o.kt)("p",null,"A basic BetterDiscord plugin could look something like this:"),(0,o.kt)(d,{names:["Class","Callback"],mdxType:"CodeTabs"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @name MyPlugin\n * @author YourName\n * @version 0.1.0\n * @description What the plugin does.\n */\n\nmodule.exports = class MyPlugin {\n    constructor(meta) {\n        // do something when the plugin is loaded\n    }\n    start() {\n        // do something on plugin start\n    }\n    stop() {\n        // do something on plugin stop\n    }\n};\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"/**\n * @name MyPlugin\n * @author YourName\n * @version 0.1.0\n * @description What the plugin does.\n */\n\nmodule.exports = (meta) => {\n    // do something when the plugin is loaded\n\n    return {\n        start() {\n            // do something on plugin start\n        },\n        stop() {\n            // do something on plugin stop\n        }\n    };\n};\n"))),(0,o.kt)("p",null,"BetterDiscord also provides the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/bdapi"},(0,o.kt)("inlineCode",{parentName:"a"},"BdApi"))," global, which has a few very helpful things for plugins.\nIt handles storing & loading plugin data as well as injecting & removing styles (CSS)."),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/react"},"react")," and ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/react-dom"},"react-dom")," packages are available as\n",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/bdapi#react"},(0,o.kt)("inlineCode",{parentName:"a"},"BdApi.React"))," and ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/bdapi#reactdom"},(0,o.kt)("inlineCode",{parentName:"a"},"BdApi.ReactDOM")),".\nThey are the same instances as the ones used by Discord. Always use these and ",(0,o.kt)("strong",{parentName:"p"},"do not")," bundle your own versions."),(0,o.kt)(l,{type:"info",mdxType:"Banner"},(0,o.kt)("p",null,"When using ",(0,o.kt)("a",{parentName:"p",href:"https://reactjs.org/docs/introducing-jsx.html"},"JSX")," in a plugin, it has to be transpiled.")),(0,o.kt)(d,{names:["JSX","JS"],mdxType:"CodeTabs"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'const {React} = BdApi;\n\nconst MyComponent = () => (\n    <div className="foo">\n        Hello world!\n    </div>\n);\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'const {React} = BdApi;\n\nconst MyComponent = () => React.createElement(\n    "div",\n    {className: "foo"},\n    "Hello World!"\n);\n'))),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"ReactDOM")," will not see much use in actual plugins, since most of the time you are rendering into already existing React element trees."),(0,o.kt)("p",null,"In ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi")," we also find the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/patcher"},(0,o.kt)("inlineCode",{parentName:"a"},"BdApi.Patcher")),", which is used to modify existing functions at runtime.\nMore details on patching will follow later on."),(0,o.kt)("p",null,"Lastly, ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/webpack"},(0,o.kt)("inlineCode",{parentName:"a"},"BdApi.Webpack"))," features a few utilities used to search through the webpack export cache.\nWe will take a closer look at this next."),(0,o.kt)("h2",null,"Webpack modules"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://webpack.js.org"},"Webpack")," is a ",(0,o.kt)("strong",{parentName:"p"},"bundler"),", meaning at its core it is a tool to take a collection of JS modules and merge them together into one or multiple big files for production.\nA module may import other modules and then expose some exports of its own.\nIn order to avoid executing the modules multiple times, webpack keeps exports of already executed modules in a cache."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/webpack"},(0,o.kt)("inlineCode",{parentName:"a"},"BdApi.Webpack"))," allows us to search through this export cache\nin order to find variables, functions, objects or React components internally used by Discord.\n",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/webpack#getmodule"},(0,o.kt)("inlineCode",{parentName:"a"},"Webpack.getModule(filter, options)"))," takes a filter function and searches through the exports of all currently cached modules."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/filters"},(0,o.kt)("inlineCode",{parentName:"a"},"Webpack.Filters"))," contains helpers to create commonly used search filter patterns.\nThe two most used ones are ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/filters#byprops"},(0,o.kt)("inlineCode",{parentName:"a"},"Filters.byProps(...props)")),"\nand ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/filters#bydisplayname"},(0,o.kt)("inlineCode",{parentName:"a"},"Filters.byDisplayName(name)")),",\nsearching by properties of ",(0,o.kt)("inlineCode",{parentName:"p"},"module.exports")," and a specific ",(0,o.kt)("inlineCode",{parentName:"p"},"displayName")," on the export respectively."),(0,o.kt)("p",null,"When trying to hook into Discord's internals, searching for the relevant webpack modules is the first step.\nThis may involve reading Discord's source code, inspecting components through React dev tools, experimenting in the console etc."),(0,o.kt)(l,{type:"warn",mdxType:"Banner"},(0,o.kt)("p",null,"Details in the following examples ",(0,o.kt)("strong",{parentName:"p"},"are outdated"),".\nDiscord's internals are undocumented and can change at any time.")),(0,o.kt)("p",null,"As an example, we will use Discord's message component.\nInspecting with React dev tools makes us realize a message consists of multiple components.\nOne parent component is responsible for rendering child components like the header, the content or accessories like reactions."),(0,o.kt)("p",null,(0,o.kt)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"unset",marginRight:"unset",maxWidth:"364px",marginTop:"10px",marginBottom:"10px"}},"\n      ",(0,o.kt)("a",{parentName:"span",className:"gatsby-resp-image-link",href:"/static/2eb6db5d729737f1027b41cd8b760b83/e45a9/message-components.png",style:{display:"block"},target:"_blank",rel:"noopener"},"\n    ",(0,o.kt)("span",{parentName:"a",className:"gatsby-resp-image-background-image",style:{paddingBottom:"129.14285714285714%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAA7DAAAOwwHHb6hkAAADS0lEQVRIx62Uy2/jZBTF82/ABqG849hOmqfzftqJncROkybqtNO06WQmI2AkFkg8ZpDYdcWIgQ0IBBILQBpU/sMf+pzHJKFNs2Bx9PlxfXzuPfdeTzCaRCC0PCNyCrmgE2s4qA2HWKZBPN0gU2lRaXTIFpsktSpVvUcsXaLZGfJ4MiOeLhFW0nhCUoIVglLCJVTLbY7MEXFzxJGmk0jrFJpdDGtATe9RrlvUDZtYqkjbHvHs+QtS2QqSIHynMLVQqGaQKxaqOUYxx8RzLRJaG02QtPvkayapQoOK3kNJFmk7Y67nL4hnq4TVDJ73X/7KO/zGe1/8TPzmT8rf3VJ58w/+V7/wwec/Unz9ltqbW0qv/6b87Vvq39+i3PyF/OonUl/9QPLmD7zf/I7nw+4VW7AmSMM5idmXJOZfE738DOl4RtCeEloi7Fy7p683xWtdEDDP1/cef7rOLoLZJhH9BLU5IJQzCGYaeFO1/8CXqrnxvnR9fe/x5Vrswp9rEa7YqM4Vcn+K1DlHrtrLd+0lFnGr+NW1x7/5QDPWL4L5FlHrjNjpRyijOXHrlEjRXMfsfrPCvYR+zSBctVH6Uzf1YNEikG9vffwg4S5pQDOImo+ItcZE8i28WR1v1nBPEbeO3SD17PujuA6XuyjH16iDa8LmGf3pJzhXHyOVu67iBxXepVK2zlBHz1DHz0nZFyT1weEp36dSHT5FHszcegZyLbw7MXsJN9tBBIdKHZTuY9R63zVrn4h7CbeIhTmtMWp/6vbj/0IoJiduPSJSWPaicPkOt++t4VZLZHWixhj1eOo6LqYnal+iDJ6gLBUfpHBVP7k3QR3OFgTDGTF7wuTTl1RH10TL3cNMWbdNzkDunKOcPHVbx1XnXKHZ50gla7vN9qW8IhR1CguV9iUx/cQdQb+o412lebBtNAPJGLl1EwrFCEpFc2v0DiZcBUXEghg8QR3NF4Z0L4j2LpA6i77cHb+DRi9qnqKKnVhz8ImNUzDxFyyCy+1z2KSsU9EJl3uoG+rUuuP+SGyezXjvg6Zoy8LnWq67ymCG7FyhOJeLDSTmW2x18Ww448g42W9KQNMXW9s6Q6508YlURZp5k4BYuMWOm36gsLgOFkz+BZgugNfEt5yCAAAAAElFTkSuQmCC')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,o.kt)("img",{parentName:"a",className:"gatsby-resp-image-image",alt:"Message components",title:"Message components",src:"/static/2eb6db5d729737f1027b41cd8b760b83/e45a9/message-components.png",srcSet:["/static/2eb6db5d729737f1027b41cd8b760b83/4edbd/message-components.png 175w","/static/2eb6db5d729737f1027b41cd8b760b83/13ae7/message-components.png 350w","/static/2eb6db5d729737f1027b41cd8b760b83/e45a9/message-components.png 364w"],sizes:"(max-width: 364px) 100vw, 364px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy",decoding:"async"}),"\n  "),"\n    ")),(0,o.kt)("p",null,"You can inspect a components source by clicking on the ",(0,o.kt)("inlineCode",{parentName:"p"},"<>")," in React dev tools.\nThe current props & hooks as well as the component type for the currently selected component can also be accessed in the console via the ",(0,o.kt)("inlineCode",{parentName:"p"},"$r")," global."),(0,o.kt)("p",null,(0,o.kt)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"unset",marginRight:"unset",maxWidth:"206px",marginTop:"10px",marginBottom:"10px"}},"\n      ",(0,o.kt)("a",{parentName:"span",className:"gatsby-resp-image-link",href:"/static/23ef94e2793863d698744a1935b52acd/a414c/view-source.png",style:{display:"block"},target:"_blank",rel:"noopener"},"\n    ",(0,o.kt)("span",{parentName:"a",className:"gatsby-resp-image-background-image",style:{paddingBottom:"36%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABa0lEQVQoz41R20oCURT1MwQFu3gZNTU1tTIki/FWpPPUjSnLprSH6FOiiAhCSoI+RFQmFRP7ggZ1FHHUZ2OFRy0fgnpYrL3WPnvvs9kyam4B/4HOaP+OpzUmaPRWqKl5zOosJKc12EhONlmgNzlgMDv/BJe4hGcthI3wNnZZDkaLEyurflIvGzQaT5/RmqFQ6aBQUVBMUb+zioLLvQ41ZYXZtgzHkhfKaT24+AUsdjdk418NVvDSmzg6OUc0lsDhcXwCQz3299gY2Ogp2OgZ9g844j2lXrDF7AwbmqyLkCs1SD4+47Pfh/AhoNvtQpIkwu12G81mE41GA61WC2JdREfqoFqtEl8URfR6PTwkU8OVjRYX5Eo1rq7vUKvVkU5nUC5XUCgUCXg+j9JbGfl8EZXK+1CXyshkc+D5V2SzOQiCgJvb+5+jDK5kd3pAByPwhRjQgTCJ6UAEvgEHR0w0Q7Q/xJC3vlFsd3nwBRCxKpwp+piWAAAAAElFTkSuQmCC')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,o.kt)("img",{parentName:"a",className:"gatsby-resp-image-image",alt:"View source",title:"View source",src:"/static/23ef94e2793863d698744a1935b52acd/a414c/view-source.png",srcSet:["/static/23ef94e2793863d698744a1935b52acd/4edbd/view-source.png 175w","/static/23ef94e2793863d698744a1935b52acd/a414c/view-source.png 206w"],sizes:"(max-width: 206px) 100vw, 206px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy",decoding:"async"}),"\n  "),"\n    ")),(0,o.kt)("p",null,"Here is a rough overview of the source code of the module containing the parent component:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'(e, t, n) => {\n    "use strict";\n    Object.defineProperty(t, "__esModule", {\n        value: !0\n    });\n\n    t.ThreadStarterChatMessage = function(e) {\n        /* component source... */\n    };\n    t.default = void 0;\n    t.getElementFromMessageId = function(e, t) {\n        /* function source... */\n    };\n\n    var r, o = /* React import */, /* other imports... */;\n\n    /* other not exported functions/components... */\n\n    var J = o.memo(function(e) { // OUR COMPONENT\n        /* component source... */\n    });\n    t.default = J\n}\n')),(0,o.kt)("p",null,"Our component is the anonymous function component inside of the ",(0,o.kt)("inlineCode",{parentName:"p"},"o.memo()")," call.\nAs we can see, it is wrapped inside of a ",(0,o.kt)("a",{parentName:"p",href:"https://reactjs.org/docs/react-api.html#reactmemo"},"React memo")," and then exported as default export from its module.\nThe module also has two other named exports: a ",(0,o.kt)("inlineCode",{parentName:"p"},"ThreadStarterChatMessage")," component and a ",(0,o.kt)("inlineCode",{parentName:"p"},"getElementFromMessageId()")," function."),(0,o.kt)("p",null,"Knowing this, we can now formulate a predicate to find the module's exports in webpack's cache using ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi"),".\nWe want a module whose exports have a ",(0,o.kt)("inlineCode",{parentName:"p"},"default"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"ThreadStarterChatMessage")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"getElementFromMessageId")," entry."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},"getModule((exports) => exports.default && exports.ThreadStarterChatMessage && exports.getElementFromMessageId);\n")),(0,o.kt)("p",null,"This type of predicate is exactly what ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/filters#byprops"},(0,o.kt)("inlineCode",{parentName:"a"},"Filters.byProps(...props)"))," can be used for:\nit searches for a module with the passed string arguments as properties/keys.\nAn equivalent version would look like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const Message = getModule(Filters.byProps("default", "ThreadStarterChatMessage", "getElementFromMessageId"));\n')),(0,o.kt)("p",null,"When formulating predicates you have to consider how specific it should be.\nWhen being very specific you are unlikely to accidentally find a different module that also matches the predicate.\nHowever, a very specific predicate may also break very fast when Discord changes something in their internals."),(0,o.kt)("p",null,"Feel free to explore Discord's modules using the ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi")," and the dev tools.\nYou do not always have to start with the UI layer and then navigate through source code until you find what you were looking for.\nSometimes taking a shot in the dark with your searches can help finding the right module as well.\nFor example, we could do a generic search for all modules exporting something with ",(0,o.kt)("inlineCode",{parentName:"p"},'"friend"')," in the key:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'getModule(\n    (exports) => Object.keys(exports).some((key) => key.toLowerCase().includes("friend")),\n    {first: false}\n)\n')),(0,o.kt)("p",null,"This example will ",(0,o.kt)("strong",{parentName:"p"},"not")," work if what we are looking for is not directly exported from the module as either a key of the default export or a named export.\nFor example the relationships store will not be included in the output since it is a class instance\nand the ",(0,o.kt)("inlineCode",{parentName:"p"},"isFriend()")," method is defined on its ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/Object_prototypes"},"prototype"),".\n",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/keys"},(0,o.kt)("inlineCode",{parentName:"a"},"Object.keys()"))," simply will not include the method.\nIf we know we are looking for a store instance, we could search through the keys of the prototype instead:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'getModule(\n    (exports) => Object.keys(Object.getPrototypeOf(exports)).some((key) => key.toLowerCase().includes("friend")),\n    {first: false}\n)\n')),(0,o.kt)("h2",null,"Patching"),(0,o.kt)("p",null,"With the module found, we can now hook into the component.\nThis is done using the already mentioned ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/plugins/api/patcher"},(0,o.kt)("inlineCode",{parentName:"a"},"BdApi.Patcher")),".\nIt allows us to change the behaviour of existing functions at runtime, executing our own code before, after or instead of the original.\nThis is commonly referred to as ",(0,o.kt)("em",{parentName:"p"},'"monkey patching"')," or simply ",(0,o.kt)("em",{parentName:"p"},'"patching"'),"."),(0,o.kt)("p",null,"There is three different kinds of patches the ",(0,o.kt)("inlineCode",{parentName:"p"},"BdApi.Patcher")," offers.\nTypically, you will use ",(0,o.kt)("inlineCode",{parentName:"p"},"before")," patches when you want to intercept and manipulate the incoming function arguments,\n",(0,o.kt)("inlineCode",{parentName:"p"},"after")," patches when you want to intercept and manipulate the resulting return value\nand ",(0,o.kt)("inlineCode",{parentName:"p"},"instead")," patches when the behaviour should be changed completely or for other complex scenarios."),(0,o.kt)("p",null,"In React components you typically want to modify the return value of the original in order to change the elements rendered.\nThis means we want to create an ",(0,o.kt)("inlineCode",{parentName:"p"},"after")," patch.\nFor class components the target function is ",(0,o.kt)("inlineCode",{parentName:"p"},"Component.prototype.render()")," usually.\nFor function components it is the component itself."),(0,o.kt)("p",null,"Remember: in our case we have a function component is wrapped inside a ",(0,o.kt)("a",{parentName:"p",href:"https://reactjs.org/docs/react-api.html#reactmemo"},"React memo"),".\nA memo stores the wrapped component in its ",(0,o.kt)("inlineCode",{parentName:"p"},"type")," property.\nWe will simply leave the memo as it is and patch its ",(0,o.kt)("inlineCode",{parentName:"p"},"type")," to hook into the contained function component."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'const Message = getModule(Filters.byProps("default", "ThreadStarterChatMessage", "getElementFromMessageId"));\n\nPatcher.after("MyPluginName", Message.default, "type", (thisObject, arguments, returnValue) => {\n    console.log("Original function received arguments:", arguments);\n    console.log("Original function returned value:", returnValue);\n});\n')),(0,o.kt)("p",null,"After the component has been patched, we still need to trigger a rerender.\nIn this case swapping channels will take care of it for us.\nWe should see output being logged into the console for each message that renders onscreen."),(0,o.kt)("p",null,(0,o.kt)("span",{parentName:"p",className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"unset",marginRight:"unset",maxWidth:"700px",marginTop:"10px",marginBottom:"10px"}},"\n      ",(0,o.kt)("a",{parentName:"span",className:"gatsby-resp-image-link",href:"/static/9330ecfc8056cb2d3468fd489ee324e2/d48f1/console-output.png",style:{display:"block"},target:"_blank",rel:"noopener"},"\n    ",(0,o.kt)("span",{parentName:"a",className:"gatsby-resp-image-background-image",style:{paddingBottom:"22.285714285714285%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAwElEQVQY0zWPWXLDMAxDfZemE2ujFkq05MRt738pZEhPPzDkB/EIbCFmHPNEY0FtA8yCPiZKZZvCDCZCjRGNCD4Q1JMLg3IzJapwLuLr8cTmfMKQiVyaSUGNBxIVMxUiUIhIPiCFiN1FOB8NGsL9QPXc/Q1U+vXzBzkWRBaO+cL5uiyx7qt3SC0YmTBKRkwFRBW1dZR6S4Mo9PG9Y9OD9/WLIQtDKx4n5npbStuZDdQpoedsydSjTbTBf3UfkiX8AMAVfTSw7ldDAAAAAElFTkSuQmCC')",backgroundSize:"cover",display:"block"}}),"\n  ",(0,o.kt)("img",{parentName:"a",className:"gatsby-resp-image-image",alt:"Console output",title:"Console output",src:"/static/9330ecfc8056cb2d3468fd489ee324e2/8c557/console-output.png",srcSet:["/static/9330ecfc8056cb2d3468fd489ee324e2/4edbd/console-output.png 175w","/static/9330ecfc8056cb2d3468fd489ee324e2/13ae7/console-output.png 350w","/static/9330ecfc8056cb2d3468fd489ee324e2/8c557/console-output.png 700w","/static/9330ecfc8056cb2d3468fd489ee324e2/d48f1/console-output.png 796w"],sizes:"(max-width: 700px) 100vw, 700px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy",decoding:"async"}),"\n  "),"\n    ")),(0,o.kt)("p",null,"The first argument received is the component props just as you would expect with a function component.\nIn the case of the message component those consist of the corresponding channel object, message object and some other information.\nThe second argument is an empty object since the component does not forward any refs (or makes use of React's legacy context API)."),(0,o.kt)("p",null,"As to be expected, the return value is what a call to ",(0,o.kt)("a",{parentName:"p",href:"https://reactjs.org/docs/react-api.html#createelement"},(0,o.kt)("inlineCode",{parentName:"a"},"React.createElement()"))," returns - a tree of React element nodes.\nThe most interesting properties on these nodes are ",(0,o.kt)("inlineCode",{parentName:"p"},"type"),", which indicates what kind of element or component this tree node is,\nand ",(0,o.kt)("inlineCode",{parentName:"p"},"props"),", which is the props passed to the HTML element or React component.\nChild nodes are found under ",(0,o.kt)("inlineCode",{parentName:"p"},"props.children"),"."),(0,o.kt)("p",null,"If we want to render our own elements somewhere, we have to find the node we want to append them to.\nThis can be done by using tree/graph traversal algorithms like ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Depth-first_search"},"DFS")," or ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Breadth-first_search"},"BFS"),".\nYou can find examples of utility functions for tree traversal in ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/rauenzi/BDPluginLibrary/blob/master/src/modules/utilities.js#L122-L165"},"Zere's Plugin Library")," (DFS)\nor ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/Zerthox/BetterDiscord-Plugins/blob/master/dium/src/utils/react.ts#L6-L29"},"my own plugin repo")," (BFS)."),(0,o.kt)("p",null,"Assuming we have a ",(0,o.kt)("inlineCode",{parentName:"p"},"findNodeInTree(tree, predicate)")," utility function to search the tree for a specific node, appending new elements could look like this:"),(0,o.kt)(d,{names:["JSX","JS"],mdxType:"CodeTabs"},(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'Patcher.after("MyPluginName", Message.default, "type", (thisObject, [props], returnValue) => {\n    const foundNode = findNodeInTree(returnValue, (node) => node?.type === "li");\n    if (foundNode) {\n        foundNode.props.children = [\n            foundNode.props.children,\n            <div>\n                <span>This channel is</span>\n                <span>{props.channel.isPrivate() ? "private" : "not private"}</span>\n            </div>\n        ];\n    } else {\n        console.error("node was not found");\n    }\n});\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-jsx"},'Patcher.after("MyPluginName", Message.default, "type", (thisObject, [props], returnValue) => {\n    const foundNode = findNodeInTree(returnValue, (node) => node?.type === "li");\n    if (foundNode) {\n        foundNode.props.children = [\n            foundNode.props.children,\n            React.createElement("div", {},\n                React.createElement("span", {}, "This chanel is"),\n                React.createElement("span", {}, props.channel.isPrivate() ? "private" : "not private"),\n            )\n        ];\n    } else {\n        console.error("node was not found");\n    }\n});\n'))),(0,o.kt)("p",null,"Remember to undo the patches you did in ",(0,o.kt)("inlineCode",{parentName:"p"},"start()")," when your plugin is stopped:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'stop() {\n    Patcher.unpatchAll("MyPluginName");\n}\n')),(0,o.kt)("h2",null,"Further information"),(0,o.kt)("p",null,"Hopefully this helped you a bit while getting started with developing BetterDiscord plugins and using Discord's internals.\nMake sure to check the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.betterdiscord.app/"},"BetterDiscord documentation")," for information.\nReading the source code of other plugins can also help a lot when learning.\n",(0,o.kt)("em",{parentName:"p"},"(Maybe not plugins using ",(0,o.kt)("inlineCode",{parentName:"em"},"BDFDB")," by DevilBro as they can be difficult to read.)")),(0,o.kt)("p",null,"React's internals and the React fiber have not been touched here at all, but may be interesting for plugin development in some cases.\nSame thing goes for Discord's internal state management system using event dispatching and Flux."),(0,o.kt)("p",null,"If you have any questions, the ",(0,o.kt)("inlineCode",{parentName:"p"},"#programming")," channel in the ",(0,o.kt)("a",{parentName:"p",href:"https://discord.gg/0Tmfo5ZbORCRqbAd"},"BetterDiscord server")," is the place to ask."))}h.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-guides-bd-getting-started-index-mdx-d545149d5597f0c1f0d0.js.map