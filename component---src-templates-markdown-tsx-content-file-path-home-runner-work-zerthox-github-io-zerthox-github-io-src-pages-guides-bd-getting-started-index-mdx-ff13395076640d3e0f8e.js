"use strict";(self.webpackChunkzerthox_github_io=self.webpackChunkzerthox_github_io||[]).push([[728],{3160:function(e,t,n){n.r(t),n.d(t,{default:function(){return p}});var a=n(1151),o=n(7294);function r(e){const t=Object.assign({p:"p",a:"a",h2:"h2",strong:"strong",div:"div",code:"code",em:"em",pre:"pre"},(0,a.ah)(),e.components),{Banner:n,CodeTabs:r}=t;return n||s("Banner",!0),r||s("CodeTabs",!0),o.createElement(o.Fragment,null,o.createElement(t.p,null,"This guide is supposed to act as an introduction to plugin development for the ",o.createElement(t.a,{href:"https://discord.com"},"Discord")," client modification ",o.createElement(t.a,{href:"https://betterdiscord.app"},"BetterDiscord"),".\nIt mostly focuses on covering topics that are not covered by other resources, like monkey patching or webpack internals."),"\n",o.createElement(n,{type:"warn"},o.createElement(t.p,null,"This article assumes you are familiar with modern ",o.createElement(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript"},"JavaScript"),"\nlike ",o.createElement(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions"},"Arrow functions"),",\n",o.createElement(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment"},"Destructuring"),"\nand ",o.createElement(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining"},"Optional Chaining"),"\nas well as the ",o.createElement(t.a,{href:"https://reactjs.org"},"React")," UI library!")),"\n",o.createElement(t.h2,null,"Environment"),"\n",o.createElement(t.p,null,"The Discord desktop application uses ",o.createElement(t.a,{href:"https://www.electronjs.org"},"Electron"),".\nNote that plugins run in ",o.createElement(t.a,{href:"https://www.electronjs.org/docs/latest/tutorial/process-model#the-renderer-process"},"Electron's renderer process"),".\nThis means our environment is a ",o.createElement(t.strong,null,"browser not ",o.createElement(t.a,{href:"https://nodejs.org"},"Node.js"),"!"),".\nAs of September 2022, BetterDiscord polyfills a small subset of absolutely necessary functions in modules shipped with Node.\nHowever, this is far from exhaustive."),"\n",o.createElement(t.p,null,"The UI is created using ",o.createElement(t.a,{href:"https://reactjs.org"},"React")," and all of the data is handled by a custom event system and a custom ",o.createElement(t.a,{href:"https://facebook.github.io/flux/"},"Flux")," implementation.\nTheir source is most likely written in ",o.createElement(t.a,{href:"https://www.typescriptlang.org"},"TypeScript"),", however that is mostly irrelevant for plugin development.\nEverything is transpiled with ",o.createElement(t.a,{href:"https://swc.rs"},"SWC")," and then bundled together using ",o.createElement(t.a,{href:"https://webpack.js.org"},"webpack"),"."),"\n",o.createElement(t.p,null,"Thanks to being based on ",o.createElement(t.a,{href:"https://www.chromium.org/Home"},"Chromium"),", Electron's renderer window has the ",o.createElement(t.a,{href:"https://developer.chrome.com/docs/devtools/"},"Chrome DevTools"),".\nSince the Discord update on 25 January 2022 they are disabled by default.\nYou can reenable them in BetterDiscord's developer settings."),"\n",o.createElement(t.div,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 688px; \n                                margin-top: 10px;\n                                margin-bottom: 10px;\n                                margin-left: unset;\n                                margin-right: unset;\n                            "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/4f1328e274d88a5a8c049d1e90d36d21/ebf47/bd-devtools-setting.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 27.42857142857143%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAuUlEQVQY04XQ3QqCQBAF4H2jysxV13XV9TdlRRMK664X6LanP+EYIkF18cGwsIc5w7LSwHRnVHUHFRcQoYbNJQ5uuLBX85rjKbJ3AlRNT5jOGzRmQHFs4UtNRJguApWRz3nieHPozhbohpGw6cEVMbwgmT+sw/4GzhtyP8LW8rDZcjCd1ajNCVKltDrV4e+qXP5EtX0Fy/KR3a+4PR9g093y0iAtGqikXES6pG3Wt/rGsgXytoe5jHgBHMGtuMBCWFwAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="BetterDiscord dev tools settings"\n        title="BetterDiscord dev tools settings"\n        src="/static/4f1328e274d88a5a8c049d1e90d36d21/ebf47/bd-devtools-setting.png"\n        srcset="/static/4f1328e274d88a5a8c049d1e90d36d21/4edbd/bd-devtools-setting.png 175w,\n/static/4f1328e274d88a5a8c049d1e90d36d21/13ae7/bd-devtools-setting.png 350w,\n/static/4f1328e274d88a5a8c049d1e90d36d21/ebf47/bd-devtools-setting.png 688w"\n        sizes="(max-width: 688px) 100vw, 688px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",o.createElement(t.p,null,"Afterwards you can access the dev tools by pressing ",o.createElement(t.code,null,"Ctrl")," + ",o.createElement(t.code,null,"Shift")," + ",o.createElement(t.code,null,"I")," (or ",o.createElement(t.code,null,"Cmd")," + ",o.createElement(t.code,null,"Opt")," + ",o.createElement(t.code,null,"I")," on a Mac).\nThe dev tools will be ",o.createElement(t.strong,null,"extremely important")," for any kind of reverse engineering later on and can be used to experiment in the console."),"\n",o.createElement(t.h2,null,"React Dev Tools"),"\n",o.createElement(t.p,null,"React Developer Tools extends the regular dev tools with React specific tabs.\nIf you have debugged a React application before, you should be familiar with them.\nThey will be very helpful when working with Discord's own React components."),"\n",o.createElement(t.p,null,"In order to use them in Discord, you will need to have a ",o.createElement(t.a,{href:"https://www.google.com/intl/en_us/chrome/"},"Chrome")," installation on your computer.\nInstall the ",o.createElement(t.a,{href:"https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi/"},"React Developer Tools extension")," from the Chrome Web Store.\n",o.createElement(t.em,null,"(As an alternative manually mimicking the folder structure and placing the extension files in there will also suffice.)"),"\nThen enable the setting in BetterDiscord's developer settings and the dev tools will automatically be loaded in Discord as well."),"\n",o.createElement(t.div,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \n                                margin-top: 10px;\n                                margin-bottom: 10px;\n                                margin-left: unset;\n                                margin-right: unset;\n                            "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/e3b8b7ebc174f0252c4bbd47349adcd7/1e043/react-dev-tools.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 64.57142857142857%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACh0lEQVQ4y1WT6W7TQBSF/RoI1DVxvM54d+wkjtUmcRYKlFIW0QISAgQSqEW0VUUrQCAQIPGPF+BFP2S7KeHHsaXRne+eM3dG8fwY6QR4QRvHDXG9COmGOF6EkD5BlKDpgtUVk5XVda5eW8IwBKbtYpoO3SgmiiKCMEU4AYrwO1hOG1tGWE6M7bQRXoJuB7RMv5Jm+aiGh2YF+HGfjt8hTHJU06NpeFhOUq2X+xXZn+JNdnF6BZabVJs0O6z/C9LtkIbm8PrgiPH1HVpmuRZhiBBD+FWN7SYodtRHZmOsdIAdZmiGVzuz/jmsXQastyRvDt4xLG7j+wPieELYbuOGDqpRN1ZMN0XmU+zeGNEZYoUZuojRLiCLKoGnZx+Zbt3BDXpIr40hgsrtvEYp48lsgugWGG6K5iQYMr50tag1VXL+4Qu3dh6QZkPSbIRwk/9qlfIj0gFmsonXG2H7nYsBhHXsC5WN11qSsw9f6G9MKremjCvI4tEommpjRxlBsc3w5j3Cdo7WEmja/9J1yfqazvn5J/LBjDVVXMK0edPSYaM7Qd28TfH0kMdHH+nff4aabdHozWguSM1mLCcF77/9It+YVG71hdswBytL+yesPjrBf/sD6/AnrRefWN4/ZmlvriOW9o9ZeXTClYfHnP7+Q54Xl8DFW1BFbgY5qp9jju5gX9/DmjzAHmyj9aZo2Qwj38JIR6hBzorscvb5O/nmtBpQCSkfxRxcR+5MaCQFZnEPcfcF3YevCG/sY21uYw12UPtbNLszmp0py/GQ91//Ra4G6qXVcC6BzXRMoz1C39hG7j7Hv/+ScOcpg90n9G7toXXrhmo6ZjkccPr5Rw1U68jqxUOYR/4Lu6WwTaBlxwAAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="React dev tools"\n        title="React dev tools"\n        src="/static/e3b8b7ebc174f0252c4bbd47349adcd7/1e043/react-dev-tools.png"\n        srcset="/static/e3b8b7ebc174f0252c4bbd47349adcd7/4edbd/react-dev-tools.png 175w,\n/static/e3b8b7ebc174f0252c4bbd47349adcd7/13ae7/react-dev-tools.png 350w,\n/static/e3b8b7ebc174f0252c4bbd47349adcd7/1e043/react-dev-tools.png 690w"\n        sizes="(max-width: 690px) 100vw, 690px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",o.createElement(n,{type:"warn"},o.createElement(t.p,null,"Since version 4.27.0 React Developer Tools has ",o.createElement(t.a,{href:"https://github.com/facebook/react/tree/main/packages/react-devtools#the-issue-with-chrome-v101-and-earlier"},"issues with Chromium versions older than 102"),".\nAs of December 2022, Discord stable is on 91 and Canary is on 98.")),"\n",o.createElement(t.h2,null,"BetterDiscord API"),"\n",o.createElement(t.p,null,"BetterDiscords full API will ",o.createElement(t.strong,null,"not")," be covered here in details.\nYou can find additional information on the ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/"},"BetterDiscord documentation")," (still work in progress).\nIf you encounter any outdated or unclear parts, you should ask in the ",o.createElement(t.a,{href:"https://discord.gg/0Tmfo5ZbORCRqbAd"},"BetterDiscord server"),"."),"\n",o.createElement(t.p,null,"A basic BetterDiscord plugin could look something like this:"),"\n",o.createElement(r,{names:["Class","Callback"]},o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},"/**\n * @name MyPlugin\n * @author YourName\n * @version 0.1.0\n * @description What the plugin does.\n */\n\nmodule.exports = class MyPlugin {\n    constructor(meta) {\n        // do something when the plugin is loaded\n    }\n    start() {\n        // do something on plugin start\n    }\n    stop() {\n        // do something on plugin stop\n    }\n};\n")),o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},"/**\n * @name MyPlugin\n * @author YourName\n * @version 0.1.0\n * @description What the plugin does.\n */\n\nmodule.exports = (meta) => {\n    // do something when the plugin is loaded\n\n    return {\n        start() {\n            // do something on plugin start\n        },\n        stop() {\n            // do something on plugin stop\n        }\n    };\n};\n"))),"\n",o.createElement(t.p,null,"BetterDiscord also provides the ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/bdapi"},o.createElement(t.code,null,"BdApi"))," global, which has a few very helpful things for plugins.\nIt handles storing & loading plugin data as well as injecting & removing styles (CSS)."),"\n",o.createElement(t.p,null,"The ",o.createElement(t.a,{href:"https://www.npmjs.com/package/react"},"react")," and ",o.createElement(t.a,{href:"https://www.npmjs.com/package/react-dom"},"react-dom")," packages are available as\n",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/bdapi#react"},o.createElement(t.code,null,"BdApi.React"))," and ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/bdapi#reactdom"},o.createElement(t.code,null,"BdApi.ReactDOM")),".\nThey are the same instances as the ones used by Discord. Always use these and ",o.createElement(t.strong,null,"do not")," bundle your own versions."),"\n",o.createElement(n,{type:"info"},"When using ",o.createElement(t.a,{href:"https://reactjs.org/docs/introducing-jsx.html"},"JSX")," in a plugin, it has to be transpiled."),"\n",o.createElement(r,{names:["JSX","JS"]},o.createElement(t.pre,null,o.createElement(t.code,{className:"language-jsx"},'const { React } = BdApi;\n\nconst MyComponent = () => (\n    <div className="foo">\n        Hello world!\n    </div>\n);\n')),o.createElement(t.pre,null,o.createElement(t.code,{className:"language-jsx"},'const { React } = BdApi;\n\nconst MyComponent = () => React.createElement(\n    "div",\n    {className: "foo"},\n    "Hello World!"\n);\n'))),"\n",o.createElement(t.p,null,o.createElement(t.code,null,"ReactDOM")," will not see much use in actual plugins, since most of the time you are rendering into already existing React element trees."),"\n",o.createElement(t.p,null,"In ",o.createElement(t.code,null,"BdApi")," we also find the ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/patcher"},o.createElement(t.code,null,"BdApi.Patcher")),", which is used to modify existing functions at runtime.\nMore details on patching will follow later on."),"\n",o.createElement(t.p,null,"Lastly, ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/webpack"},o.createElement(t.code,null,"BdApi.Webpack"))," features a few utilities used to search through the webpack export cache.\nWe will take a closer look at this next."),"\n",o.createElement(t.h2,null,"Webpack modules"),"\n",o.createElement(t.p,null,o.createElement(t.a,{href:"https://webpack.js.org"},"Webpack")," is a ",o.createElement(t.strong,null,"bundler"),", meaning at its core it is a tool to take a collection of JS modules and merge them together into one or multiple big files for production.\nA module may import other modules and then expose some exports of its own.\nIn order to avoid executing the modules multiple times, webpack keeps exports of already executed modules in a cache."),"\n",o.createElement(t.p,null,o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/webpack"},o.createElement(t.code,null,"BdApi.Webpack"))," allows us to search through this export cache\nin order to find variables, functions, objects or React components internally used by Discord.\n",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/webpack#getmodule"},o.createElement(t.code,null,"Webpack.getModule(filter, options)"))," takes a filter function and searches through the exports of all currently cached modules."),"\n",o.createElement(t.p,null,o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/filters"},o.createElement(t.code,null,"Webpack.Filters"))," contains helpers to create commonly used search filter patterns.\n",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/filters#byprops"},o.createElement(t.code,null,"Filters.byProps(...props)"))," possibly should have been named something like ",o.createElement(t.code,null,"byKeys")," instead,\nsince people tend to confuse it with React's Component props.\nIt has nothing to do with React's props, it searches for specific properties (keys) in ",o.createElement(t.code,null,"module.exports"),".\n",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/filters#bydisplayname"},o.createElement(t.code,null,"Filters.byDisplayName(name)"))," searches for a specific ",o.createElement(t.code,null,"displayName")," set on the object.\n",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/filters#bystrings"},o.createElement(t.code,null,"Filters.byStrings(...strings)"))," is best explained as something similar to ",o.createElement(t.code,null,"target.toString().includes(...)"),"."),"\n",o.createElement(t.p,null,"When trying to hook into Discord's internals, searching for the relevant webpack modules is the first step.\nThis may involve reading Discord's source code, inspecting components through React dev tools, experimenting in the console etc."),"\n",o.createElement(t.h2,null,"Finding a component"),"\n",o.createElement(n,{type:"warn"},"Details in the following examples may be outed. Discord's internals are undocumented and can change at any time."),"\n",o.createElement(t.p,null,'The Discord update on 27 September 2022 brought some major changes to characteristics of their production code.\nNamed top-level exports have had their names "mangled" (minified).\nThe module merging also became more aggressive, merging e.g. all of the channel list components into a single module.\nThese changes pose additional challenges when searching modules.'),"\n",o.createElement(t.p,null,"As a first example, we will attempt to find Discord's button component in their webpack modules.\nWhen inspecting in React devtools, the first component we stumble upon is called ",o.createElement(t.code,null,"U"),".\nLooking at its received props, we realize this can't be the component we are looking for:\nit's receiving the element as children, meaning those were rendered by one of its parents!"),"\n",o.createElement(t.div,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 151px; \n                                margin-top: 10px;\n                                margin-bottom: 10px;\n                                margin-left: unset;\n                                margin-right: unset;\n                            "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/9f287bbecf601e29c6c1b1952ecb6846/29fe9/button-component-u.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 68.21192052980133%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABwklEQVQ4y6WTW3PSUBDH800slxAg5EJuQOVS20LKJcAkBItCaSlaZ2rVmbajD1Qf9NVP4If9O7tDMtgZnUl92NmcPSe/s//ds0K+ZCElm0jLJnJFA9m8zp7ikmyyT2LCM9nEWq9irtgoVVs46njQzOcxNDEwI5v4ZdXxU3Vw0B3j5uMdDLsBsVB+GjAvmyyNMippFdi1gxgmbfeSmFBQbERGEALvxpKa8DiTour8lwmqUYNVacFwGjCc5pOlxpLXVzd4/+EOD99+YPP1O9eQZNNtu6WI7I8SPdrjpih6ld8eHUjnNKREFRlJx56oIJ1TkRKVuElZSeNYJqfGnmLR++UMow6TZD+cY+Sf4tgdIjw9Q38YYjCaotY4hlgw0GoP4HohXG8CL3iFds9H46gH1dhH/UUXsl6lLltM32+2MZ0tMZuvMA5mmC/fsD+7uILb9/lMZxBgulhjHC5w4oUIZudo932YlRYO3RGDhUg7102xoZRrnHpUp71siWEUJ89SJY2lZrbfuyPLQL69O8b95w0u315juXqHT7dfMHm5YKhu1eEFrzmD6LK/T8r2mVAGNMO0Llt1htCafqZ9gkXf/xq93yU5wnCtzJg7AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Button component U"\n        title="Button component U"\n        src="/static/9f287bbecf601e29c6c1b1952ecb6846/29fe9/button-component-u.png"\n        srcset="/static/9f287bbecf601e29c6c1b1952ecb6846/29fe9/button-component-u.png 151w"\n        sizes="(max-width: 151px) 100vw, 151px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",o.createElement(t.p,null,"Going up to the direct parent we find component ",o.createElement(t.code,null,"y"),", which is the component we are looking for.\nWe inspect its source and click the pretty print button in oder to see what we are working with."),"\n",o.createElement(t.div,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 206px; \n                                margin-top: 10px;\n                                margin-bottom: 10px;\n                                margin-left: unset;\n                                margin-right: unset;\n                            "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/23ef94e2793863d698744a1935b52acd/a414c/view-source.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 36%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABa0lEQVQoz41R20oCURT1MwQFu3gZNTU1tTIki/FWpPPUjSnLprSH6FOiiAhCSoI+RFQmFRP7ggZ1FHHUZ2OFRy0fgnpYrL3WPnvvs9kyam4B/4HOaP+OpzUmaPRWqKl5zOosJKc12EhONlmgNzlgMDv/BJe4hGcthI3wNnZZDkaLEyurflIvGzQaT5/RmqFQ6aBQUVBMUb+zioLLvQ41ZYXZtgzHkhfKaT24+AUsdjdk418NVvDSmzg6OUc0lsDhcXwCQz3299gY2Ogp2OgZ9g844j2lXrDF7AwbmqyLkCs1SD4+47Pfh/AhoNvtQpIkwu12G81mE41GA61WC2JdREfqoFqtEl8URfR6PTwkU8OVjRYX5Eo1rq7vUKvVkU5nUC5XUCgUCXg+j9JbGfl8EZXK+1CXyshkc+D5V2SzOQiCgJvb+5+jDK5kd3pAByPwhRjQgTCJ6UAEvgEHR0w0Q7Q/xJC3vlFsd3nwBRCxKpwp+piWAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="View source"\n        title="View source"\n        src="/static/23ef94e2793863d698744a1935b52acd/a414c/view-source.png"\n        srcset="/static/23ef94e2793863d698744a1935b52acd/4edbd/view-source.png 175w,\n/static/23ef94e2793863d698744a1935b52acd/a414c/view-source.png 206w"\n        sizes="(max-width: 206px) 100vw, 206px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",o.createElement(t.p,null,"This brings us to something similar to:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},"var y = function (e) {\n    var t = e.look,\n        n = void 0 === t ? m.FILLED : t,\n        i = e.color,\n        u = void 0 === i ? T.BRAND : i,\n        _ = e.borderColor,\n        O = e.hover,\n        v = e.size,\n        y = void 0 === v ? g.MEDIUM : v,\n        /* other props... */;\n    // local vars, hooks...\n    var ie = (0, r.jsx)(s.tE, /* react elements... */);\n    if (te) {\n        // alternative return...\n    }\n    return ie;\n}\ny.Looks = m;\ny.Colors = T;\ny.BorderColors = O;\ny.Hovers = v;\ny.Sizes = g;\ny.Link = function (e) {\n    // component source...\n};\nconst A = y;\n")),"\n",o.createElement(t.p,null,"Going up to the top of the module, we find that our component is exported directly (line 9):"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'191940: (e, t, n) => {\n    "use strict";\n    n.d(t, {\n        iL: () => m,\n        Tt: () => T,\n        lN: () => v,\n        Ph: () => g,\n        nY: () => S,\n        Co: () => A\n    });\n')),"\n",o.createElement(t.p,null,"To explain the codeblock above: it starts with a key in an object literal, which is the id of the module.\nThe following value is the module function holding the module's code.\nWhen evaluating the module webpack will pass its own versions of ",o.createElement(t.code,null,"module"),", ",o.createElement(t.code,null,"module.exports"),", ",o.createElement(t.code,null,"require")," as arguments in this order.\n",o.createElement(t.code,null,"require.d")," is a helper to define getters."),"\n",o.createElement(t.p,null,"Jumping back to the button component itself, we will take a look at two approaches for retrieving it.\nWe do so by formulating a search predicate in order to match it within webpack's export cache."),"\n",o.createElement(t.p,null,"When formulating predicates you have to consider how specific it should be.\nWhen being very specific you are unlikely to accidentally find a different module that also matches the predicate.\nHowever, a very specific predicate may also break very fast when Discord changes something in their internals.\nYou can check how many potentially wrong modules your predicate currently matches by passing ",o.createElement(t.code,null,"first: false")," to ",o.createElement(t.code,null,"getModule()"),"."),"\n",o.createElement(t.p,null,"The first way is the currently most common way to build search predicates for components.\nWe do not any have export names or component ",o.createElement(t.code,null,"displayName"),"s to work with.\nHowever, the component possibly still accesses the React component props it recieves.\nWe can use these to create a predicate using ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/filters#bystrings"},o.createElement(t.code,null,"Filters.byStrings(...strings)")),"\nLooking at the component source, we can figure out which accesssed props could be a suitable for our query."),"\n",o.createElement(t.p,null,"In this case ",o.createElement(t.code,null,"submittingStartedLabel")," and ",o.createElement(t.code,null,"submittingFinishedLabel")," are two props with fairly specific names which are accessed within the component.\nAnd indeed, we only get a single match using either of them:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'getModule(Filters.byStrings("submittingStartedLabel"), {searchExports: true, first: false})\n')),"\n",o.createElement(t.p,null,'If we are afraid these props are too special and might be removed from the component in the future, we can combine multiple of the more "basic" props.\nThe query below returns 12 matches:'),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'getModule(Filters.byStrings("look", "submitting"), {searchExports: true, first: false})\n')),"\n",o.createElement(t.p,null,"One thing we can change is to add the ",o.createElement(t.code,null,".")," from accessing the property in front.\nDiscord's toolchain (usually) transpiles destructuring them into regular property access operations.\nThis cuts down our number of matches to 2:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'getModule(Filters.byStrings(".look", ".submitting"), {searchExports: true, first: false})\n')),"\n",o.createElement(t.p,null,'We can also take a look at the "wrong" matches and attempt to find code fragments that are present in our component but not the others.\nIn this case the other component for example does not access an ',o.createElement(t.code,null,"onClick")," prop, leaving us with this possible query for the button component:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'const Button = getModule(Filters.byStrings(".look", ".submitting", ".onClick"), {searchExports: true});\n')),"\n",o.createElement(t.p,null,"The second way for formulating predicates is one that can only be applied in special cases.\nLooking at our component source code again, we happen to have a handful of assignments right below our function component.\nThese add enum-like objects and another associated function component.\nKnowing this, we can attempt to use ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/filters#byprops"},o.createElement(t.code,null,"Filters.byProps(...props)"))," and match these properties instead of matching the component source:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'const Button = getModule(Filters.byProps("Link", "Colors"), {searchExports: true});\n')),"\n",o.createElement(t.p,null,"If a component or function is ",o.createElement(t.strong,null,"not exported")," from its module, things become a lot more complicated.\nMore advanced techniques like chain patching or dummy rendering plus traversing React fiber will be required."),"\n",o.createElement(t.h2,null,"Finding a store"),"\n",o.createElement(t.p,null,"Discord uses the ",o.createElement(t.a,{href:"https://facebook.github.io/flux"},"Flux")," architecture to organize their data.\nYou can read more about this in ",o.createElement(t.a,{href:"../flux"},"Flux and Discord"),".\nIn the Flux architecture ",o.createElement(t.em,null,"Stores")," hold all of the relevant state information."),"\n",o.createElement(t.p,null,"As an example we will attempt to find the ",o.createElement(t.em,null,"UserStore")," by reverse engineering the component responsible for rendering the account panel below the channel list.\nSearching through the component tree for a component which does not receive the data as props from a parent brings us to a component called ",o.createElement(t.code,null,"Tee"),"."),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},"function Tee() {\n    var e = (0, s.e7)([Y.default], (function() {\n            return Y.default.getCurrentUser()\n        })),\n        // some other variables...\n        a = null == e ? void 0 : e.id,\n        l = He.Ok.useSetting(),\n        c = o.useMemo((function() {\n            return null != l ? (0,\n            Z8.Z)(l) : null\n        }), [l]),\n        u = (0, s.cj)([Hc.Z], (function() {\n            return {\n                streaming: null != Hc.Z.findActivity((function(e) {\n                    return e.type === Z.IIU.STREAMING\n                }\n                )),\n                status: Hc.Z.getStatus()\n            }\n        })),\n        f = u.streaming\n        d = u.status\n        p = (0, s.e7)([oy.Z], (function() {\n            return null != a && oy.Z.isSpeaking(a)\n        }), [a]),\n    // rest...\n}\n")),"\n",o.createElement(t.p,null,"There is a fairly obvious call to ",o.createElement(t.code,null,"getCurrentUser()")," in there.\nBut let's figure out what the rest around it is."),"\n",o.createElement(t.p,null,"We can take a closer look at the component by selecting it in React devtools and typing ",o.createElement(t.code,null,"$r")," in console.\nThe ",o.createElement(t.code,null,"type")," will contain the function, which we can help us figure out what values captured variables contain.\nIf we expand the function, we see a ",o.createElement(t.code,null,"[[Scopes]]")," entry at the bottom.\nWe can look through this manually or in case one scope of captured variables is very large:\nright click, store as global variable and then access an entry like ",o.createElement(t.code,null,"temp1.object.s"),"."),"\n",o.createElement(t.div,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \n                                margin-top: 10px;\n                                margin-bottom: 10px;\n                                margin-left: unset;\n                                margin-right: unset;\n                            "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/9f8e54ab2aae2777b790e5fb54ceedce/00b70/tee-scopes.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 24%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAs0lEQVQY042PW66DMAxEWUmhvJIQiEnSEKja/S/rVJS26s99fByNLdujceF1xs8LSluqc/sjZdX8On9TiIqMRmjanlPVvA4PfVN9mf1lXHidmI0wDO6Z8kjafS11/0r2MdzsnWW4sYY7UTJWVpSNT4zLGLdybhRlWR+Jdy3rzzenvX6x94W3CZkiISS27cYcEj4klnzFSSReMiEuyByYJFAboTcOpQx9r9FmxAwTdhTaTvMAd3uQ4qpkZUAAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Tee scopes"\n        title="Tee scopes"\n        src="/static/9f8e54ab2aae2777b790e5fb54ceedce/8c557/tee-scopes.png"\n        srcset="/static/9f8e54ab2aae2777b790e5fb54ceedce/4edbd/tee-scopes.png 175w,\n/static/9f8e54ab2aae2777b790e5fb54ceedce/13ae7/tee-scopes.png 350w,\n/static/9f8e54ab2aae2777b790e5fb54ceedce/8c557/tee-scopes.png 700w,\n/static/9f8e54ab2aae2777b790e5fb54ceedce/00b70/tee-scopes.png 733w"\n        sizes="(max-width: 700px) 100vw, 700px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",o.createElement(t.p,null,"Another helpful technique to help with reverse engineering is to set a breakpoint near the end of the function/component.\nThen attempt to trigger a call/rerender.\nWhen the breakpoint is hit, we can take a look at which values captured as well as local variables hold."),"\n",o.createElement(t.p,null,"It turns out our captured variable ",o.createElement(t.code,null,"s")," is Discord's Flux module.\nAnd the functions ",o.createElement(t.code,null,"s.e7")," and ",o.createElement(t.code,null,"s.cj")," are the mangled ",o.createElement(t.code,null,"useStateFromStores")," and ",o.createElement(t.code,null,"useStateFromStoresObject")," hooks.\n",o.createElement(t.code,null,"Y.default")," is the store we are searching.\n(Yes, big surprise...)\nBesides ",o.createElement(t.code,null,"getCurrentUser")," we for example also find the functions ",o.createElement(t.code,null,"getUsers"),", ",o.createElement(t.code,null,"getUser")," or ",o.createElement(t.code,null,"findByTag")," there."),"\n",o.createElement(r,{names:["Production code","Reverse engineered"]},o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},"var e = (0, s.e7)([Y.default], (function() {\n        return Y.default.getCurrentUser()\n    })),\n    a = null == e ? void 0 : e.id;\n")),o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},"const currentUser = Flux.useStateFromStores([UserStore], () => {\n    return UserStore.getCurrentUser();\n});\nconst id = currentUser?.id;\n"))),"\n",o.createElement(t.p,null,"Looking at our store, we can easily grab it using ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/filters#byprops"},o.createElement(t.code,null,"Filters.byProps(...props)")),".\nSince it is exported as ",o.createElement(t.code,null,"default")," export from its module, we do not need ",o.createElement(t.code,null,"searchExports: true"),".\nBetterDiscord checks our filter on both the whole exports object as well the default export by default.\nSince using ",o.createElement(t.code,null,'"getUser"')," or ",o.createElement(t.code,null,'"getCurrentUser"')," on their own gives us more than 1 match, we combine them:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'const UserStore = getModule(Filters.byProps("getUser", "getCurrentUser"));\n')),"\n",o.createElement(t.p,null,"Alternatively, we can grab the store by its name:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'const UserStore = getModule((exports) => exports?.constructor?.displayName === "UserStore");\n')),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'const UserStore = getModule((exports) => typeof exports?.getName === "function" && exports.getName() === "UserStore");\n')),"\n",o.createElement(t.h2,null,"Patching"),"\n",o.createElement(t.p,null,"Now that we know how to find modules, we can take a look at how we can hook into a function exported by one.\nThis is done using the already mentioned ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/patcher"},o.createElement(t.code,null,"BdApi.Patcher")),".\nIt allows us to change the behaviour of existing functions at runtime, executing our own code before, after or instead of the original.\nThis is commonly referred to as ",o.createElement(t.em,null,"monkey patching")," or simply ",o.createElement(t.em,null,"patching"),"."),"\n",o.createElement(t.p,null,"There is three different kinds of patches the ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/patcher"},o.createElement(t.code,null,"BdApi.Patcher"))," offers.\nTypically, you will use ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/patcher/#before"},o.createElement(t.code,null,"before"))," patches when you want to intercept and manipulate the incoming function arguments,\n",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/patcher/#after"},o.createElement(t.code,null,"after"))," patches when you want to intercept and manipulate the resulting return value\nand ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/patcher/#instead"},o.createElement(t.code,null,"instead"))," patches when the behaviour should be changed completely or for other complex scenarios.\nv\nIn React components you typically want to modify the return value of the original in order to change the elements rendered.\nThis means we want to create an ",o.createElement(t.code,null,"after")," patch.\nFor class components the target function is ",o.createElement(t.code,null,"Component.prototype.render()")," usually.\nFor function components it is the component itself."),"\n",o.createElement(t.p,null,"Note that the patcher expects an ",o.createElement(t.strong,null,"object")," containing the target function and the ",o.createElement(t.strong,null,"key")," of the function entry.\nYou may have to adjust your filter and/or use ",o.createElement(t.code,null,"defaulExport: false")," when searching with the intent to patch."),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'const myComponentModule = getModule(/* filter */);\n\nPatcher.after("MyPluginName", myComponentModule, "myComponentKey", (thisObject, originalArgs, returnValue) => {\n    console.log("Original function received arguments:", originalArgs);\n    console.log("Original function returned value:", returnValue);\n});\n')),"\n",o.createElement(t.p,null,"After the component has been patched, we still need to trigger a rerender.\nWe should see output being logged into the console for each instance of the patched component that renders onscreen."),"\n",o.createElement(t.div,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 700px; \n                                margin-top: 10px;\n                                margin-bottom: 10px;\n                                margin-left: unset;\n                                margin-right: unset;\n                            "\n    >\n      <a\n    class="gatsby-resp-image-link"\n    href="/static/9330ecfc8056cb2d3468fd489ee324e2/d48f1/console-output.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n    <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 22.285714285714285%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAwElEQVQY0zWPWXLDMAxDfZemE2ujFkq05MRt738pZEhPPzDkB/EIbCFmHPNEY0FtA8yCPiZKZZvCDCZCjRGNCD4Q1JMLg3IzJapwLuLr8cTmfMKQiVyaSUGNBxIVMxUiUIhIPiCFiN1FOB8NGsL9QPXc/Q1U+vXzBzkWRBaO+cL5uiyx7qt3SC0YmTBKRkwFRBW1dZR6S4Mo9PG9Y9OD9/WLIQtDKx4n5npbStuZDdQpoedsydSjTbTBf3UfkiX8AMAVfTSw7ldDAAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="Console output"\n        title="Console output"\n        src="/static/9330ecfc8056cb2d3468fd489ee324e2/8c557/console-output.png"\n        srcset="/static/9330ecfc8056cb2d3468fd489ee324e2/4edbd/console-output.png 175w,\n/static/9330ecfc8056cb2d3468fd489ee324e2/13ae7/console-output.png 350w,\n/static/9330ecfc8056cb2d3468fd489ee324e2/8c557/console-output.png 700w,\n/static/9330ecfc8056cb2d3468fd489ee324e2/d48f1/console-output.png 796w"\n        sizes="(max-width: 700px) 100vw, 700px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n  </a>\n    </span>'}}),"\n",o.createElement(t.p,null,"The example above is output from a function component.\nThe first argument received is the component props just as you would expect with a function component.\nThe second argument is an empty object since the component does not forward any refs (or makes use of React's legacy context API)."),"\n",o.createElement(t.p,null,"As to be expected, the return value is what a call to ",o.createElement(t.a,{href:"https://reactjs.org/docs/react-api.html#createelement"},o.createElement(t.code,null,"React.createElement()"))," returns - a tree of React element nodes.\nThe most interesting properties on these nodes are ",o.createElement(t.code,null,"type"),", which indicates what kind of element or component this tree node is,\nand ",o.createElement(t.code,null,"props"),", which is the props passed to the HTML element or React component.\nChild nodes are found under ",o.createElement(t.code,null,"props.children"),"."),"\n",o.createElement(t.p,null,"If we want to render our own elements somewhere, we have to find the node we want to append them to.\nThis can be done by using tree/graph traversal algorithms like ",o.createElement(t.a,{href:"https://en.wikipedia.org/wiki/Depth-first_search"},"DFS")," or ",o.createElement(t.a,{href:"https://en.wikipedia.org/wiki/Breadth-first_search"},"BFS"),".\nYou can find examples of utility functions for tree traversal in ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/api/utils#findintree"},o.createElement(t.code,null,"BdApi.Utils"))," (DFS),\n",o.createElement(t.a,{href:"https://github.com/rauenzi/BDPluginLibrary/blob/master/src/modules/utilities.js#L122-L165"},"Zere's Plugin Library")," (DFS)\nor ",o.createElement(t.a,{href:"https://github.com/Zerthox/BetterDiscord-Plugins/blob/069cac71f1129fc5ca29af46cf7a50675b87cf03/dium/src/utils/react.ts#L36-L59"},"my own plugin repo")," (BFS)."),"\n",o.createElement(t.p,null,"With a utility function to search the tree for a specific node, appending new elements could look like this:"),"\n",o.createElement(r,{names:["JSX","JS"]},o.createElement(t.pre,null,o.createElement(t.code,{className:"language-jsx"},'const findInReactTree = (tree, filter) => Utils.findInTree(tree, filter, {walkable: ["props", "children"]});\n\nPatcher.after("MyPluginName", myComponentModule, "myComponentKey", (thisObject, [props], returnValue) => {\n    const foundNode = findInReactTree(returnValue, (node) => node?.type === "li");\n    if (foundNode) {\n        foundNode.props.children = [\n            foundNode.props.children,\n            <div>My elements</div>\n        ];\n    } else {\n        console.error("node was not found");\n    }\n});\n')),o.createElement(t.pre,null,o.createElement(t.code,{className:"language-jsx"},'const findInReactTree = (tree, filter) => Utils.findInTree(tree, filter, {walkable: ["props", "children"]});\n\nPatcher.after("MyPluginName", myComponentModule, "myComponentKey", (thisObject, [props], returnValue) => {\n    const foundNode = findInReactTree(returnValue, (node) => node?.type === "li");\n    if (foundNode) {\n        foundNode.props.children = [\n            foundNode.props.children,\n            React.createElement("div", {}, "My elements")\n        ];\n    } else {\n        console.error("node was not found");\n    }\n});\n'))),"\n",o.createElement(t.p,null,"Remember to undo the patches you did in ",o.createElement(t.code,null,"start()")," when your plugin is stopped:"),"\n",o.createElement(t.pre,null,o.createElement(t.code,{className:"language-js"},'stop() {\n    Patcher.unpatchAll("MyPluginName");\n}\n')),"\n",o.createElement(t.h2,null,"Further information"),"\n",o.createElement(t.p,null,"Hopefully this helped you a bit while getting started with developing BetterDiscord plugins and using Discord's internals.\nMake sure to check the ",o.createElement(t.a,{href:"https://docs.betterdiscord.app/"},"BetterDiscord documentation")," for information.\nReading the source code of other plugins can also help a lot when learning.\n",o.createElement(t.em,null,"(Maybe not plugins using ",o.createElement(t.code,null,"BDFDB")," by DevilBro as they can be difficult to read.)")),"\n",o.createElement(t.p,null,"React's internals and the React fiber have not been touched here at all, but may be interesting for plugin development in some cases.\nSame thing goes for Discord's internal state management system using event dispatching and Flux."),"\n",o.createElement(t.p,null,"If you have any questions, the ",o.createElement(t.code,null,"#programming")," channel in the ",o.createElement(t.a,{href:"https://discord.gg/0Tmfo5ZbORCRqbAd"},"BetterDiscord server")," is the place to ask."))}var l=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,a.ah)(),e.components);return t?o.createElement(t,e,o.createElement(r,e)):r(e)};function s(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}var i=n(2830),c=n(6587);const d=e=>{let{children:t,data:n}=e;const{frontmatter:a,fields:r,excerpt:l}=n.mdx,{title:s,author:d,date:p,updated:m}=a;return o.createElement(i.Ar,{title:s,author:d,date:p,updated:m,readTime:Math.round(r.timeToRead),description:l},o.createElement(c.UG,null,t))};function p(e){return o.createElement(d,e,o.createElement(l,e))}}}]);
//# sourceMappingURL=component---src-templates-markdown-tsx-content-file-path-home-runner-work-zerthox-github-io-zerthox-github-io-src-pages-guides-bd-getting-started-index-mdx-ff13395076640d3e0f8e.js.map